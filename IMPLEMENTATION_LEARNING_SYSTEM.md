# 集合知システム + パーソナライゼーション実装ガイド

## 実装概要

このアップデートでは、AI Store Secretaryに**集合知システム**と**パーソナライゼーション機能**を追加しました。

### 主な機能

1. **集合知システム（Collective Intelligence）**
   - 同業種（詳細カテゴリー）の投稿データから学習
   - 大カテゴリーグループ（美容系、飲食系など）のトレンドを反映
   - ブレンド型学習：50% 自店舗 + 30% 同カテゴリー + 20% 大グループ

2. **パーソナライゼーション機能**
   - フィードバックから店舗ごとの好みを学習
   - 口調の調整（カジュアル/フォーマル）
   - 文章長の好み（簡潔/詳細）
   - 絵文字スタイル（控えめ/豊富）
   - 好まれる表現の学習

---

## デプロイ手順

### 1. データベースマイグレーション

Supabase ダッシュボード → SQL Editor で以下のSQLを実行してください：

```sql
-- database/migration_learning_system.sql の内容を実行
```

**重要な変更点:**
- `stores` テーブルに `category` カラムを追加
- `learning_profiles` テーブルを新規作成（店舗ごとの学習プロファイル）
- `engagement_metrics` テーブルを新規作成（エンゲージメント指標）
- `collective_insights` テーブルに `category_group` カラムを追加
- `post_history` テーブルに `learning_applied` JSONB カラムを追加

### 2. コードのデプロイ

```bash
cd "D:\クロードコード　でも\ai-store-secretary"
git add .
git commit -m "Add collective intelligence and personalization features"
git push
```

Railwayが自動的に再デプロイします（1-2分）。

---

## 新機能の使い方

### カテゴリーの設定（現時点では手動）

店舗にカテゴリーを設定することで、集合知機能が有効になります：

**Supabaseダッシュボードで手動設定:**

```sql
UPDATE stores
SET category = 'ネイルサロン'
WHERE name = '店舗名';
```

**対応カテゴリー一覧:**

- **美容系**: ネイルサロン、美容室、ヘアサロン、エステサロン、まつげエクステ、アイラッシュサロン、リラクゼーションサロン、マッサージサロン
- **飲食系**: カフェ、レストラン、ベーカリー、パン屋、スイーツ店、ケーキ屋、バー、居酒屋、ラーメン店、和食店、イタリアン、フレンチ
- **小売系**: アパレル、雑貨店、セレクトショップ、古着屋、アクセサリーショップ、家具店、インテリアショップ、書店、花屋
- **サービス系**: 写真スタジオ、フォトグラファー、デザイン事務所、コワーキングスペース、学習塾、ヨガスタジオ、フィットネスジム、ダンススクール
- **専門職系**: 士業、コンサルタント、税理士、行政書士、社労士、弁護士、不動産、保険代理店
- **クリエイティブ系**: ハンドメイド作家、アーティスト、イラストレーター、音楽教室、工房、アトリエ

### パーソナライゼーションの学習

フィードバックを送ることで、自動的に学習します：

```
直し: もっとカジュアルに
→ パーソナライゼーションプロファイルに「カジュアル好み」が記録される

直し: 絵文字を少なめに
→ 絵文字スタイルが「minimal」に変更される

直し: もっと詳しく説明して
→ 詳細な説明を好む傾向として学習される
```

### 投稿生成時の動作

**カテゴリーが設定されている場合:**

1. 自店舗の学習データを取得
2. 同カテゴリーの集合知を取得
3. 大カテゴリーグループの集合知を取得
4. パーソナライゼーション情報を取得
5. すべてをブレンドして投稿を生成

**プロンプトに追加される情報:**

```
【業界トレンド（参考情報）】
・同業種で人気のハッシュタグ: #ネイル, #ジェルネイル, #ネイルデザイン
・同業種の平均投稿長: 250文字
・大カテゴリーのトレンド: #美容, #セルフケア, #女子力

【パーソナライゼーション（5回の学習データ）】
・よりカジュアルな表現を好む（学習回数: 3回）
・絵文字は控えめに使用
・好まれる表現: 新鮮な, こだわり, 手作り
```

---

## 技術的な詳細

### ファイル構成

```
src/
├── config/
│   └── categoryGroups.js          # カテゴリーグループマッピング
├── services/
│   ├── collectiveIntelligence.js  # 集合知サービス
│   └── personalizationEngine.js   # パーソナライゼーションエンジン
├── handlers/
│   ├── imageHandler.js            # 画像投稿生成（拡張）
│   ├── textHandler.js             # テキスト投稿生成（拡張）
│   └── feedbackHandler.js         # フィードバック処理（拡張）
└── utils/
    └── promptBuilder.js           # プロンプト構築（拡張）

database/
└── migration_learning_system.sql  # マイグレーションSQL
```

### データフロー

**投稿生成時:**

```
ユーザー入力
  ↓
店舗情報取得（category含む）
  ↓
学習データ集約
  ↓
集合知取得（同カテゴリー + 大グループ）
  ↓
パーソナライゼーション情報取得
  ↓
プロンプト構築（すべてをブレンド）
  ↓
Claude API
  ↓
投稿生成
  ↓
エンゲージメントメトリクス保存（初期値）
```

**フィードバック時:**

```
フィードバック入力
  ↓
学習データ保存
  ↓
パーソナライゼーションプロファイル更新
  ↓
修正版生成
  ↓
投稿履歴保存
```

### ブレンド比率

```javascript
{
  own: 50,      // 自店舗の学習データ（最優先）
  category: 30, // 同カテゴリーの集合知
  group: 20,    // 大グループの集合知
}
```

---

## 次のステップ

### Phase 2: カテゴリー自動設定

店舗登録時に業種を入力できるようにする：

```
1: 店名,こだわり,口調,業種
例: 1: ベーカリー幸福堂,天然酵母の手作りパン,friendly,ベーカリー
```

### Phase 3: エンゲージメント指標の実装

実際のInstagramデータを取得して、エンゲージメントメトリクスを更新：

- Instagram Graph API連携
- 投稿のいいね数、保存数、コメント数の取得
- エンゲージメント率の自動計算

### Phase 4: 集合知の定期分析

バッチ処理で定期的に集合知を分析・更新：

- 週次でカテゴリー別のトレンドを分析
- `collective_insights` テーブルに保存
- ベストプラクティスの抽出

---

## トラブルシューティング

### マイグレーションエラー

**エラー:** `column "category_group" does not exist`

**解決策:** `migration_learning_system.sql` を再度実行してください。

### 集合知が反映されない

**原因:** `category` が設定されていない

**解決策:** Supabaseで該当店舗の `category` を設定してください。

### パーソナライゼーションが効かない

**原因:** フィードバックの回数が少ない

**解決策:** 3-5回以上フィードバックを送ると効果が顕著になります。

---

## パフォーマンス最適化

### インデックス

以下のインデックスが自動作成されます：

- `idx_learning_profiles_store_id` - 学習プロファイル検索
- `idx_engagement_metrics_category` - カテゴリー別集合知取得
- `idx_engagement_metrics_engagement_rate` - 高エンゲージメント投稿検索

### キャッシュ戦略（今後の実装）

- 集合知データを1時間キャッシュ
- パーソナライゼーション情報を30分キャッシュ

---

## モニタリング

### ログ確認

Railwayのログで以下を確認：

```
[Image] 集合知取得: category=ネイルサロン, group=美容系
[Post] テキスト投稿生成完了: store=サロンA
[Personalization] フィードバック学習完了: store=...
[CollectiveIntelligence] メトリクス保存エラー: ...
```

### データ確認

Supabaseダッシュボードで以下を確認：

```sql
-- 学習プロファイルの確認
SELECT * FROM learning_profiles WHERE store_id = '...';

-- エンゲージメントメトリクスの確認
SELECT * FROM engagement_metrics WHERE store_id = '...' ORDER BY created_at DESC LIMIT 10;

-- カテゴリー別の平均エンゲージメント率
SELECT * FROM category_engagement_summary;
```

---

## まとめ

この実装により、AI Store Secretaryは以下の差別化を実現します：

1. **集合知システム**: 同業種の成功パターンを学習
2. **パーソナライゼーション**: 使うほど店舗に最適化
3. **スケーラビリティ**: 多店舗でデータが蓄積されるほど精度向上

これにより、「個人店ならでは」の価値を提供しつつ、「集合知」で競合に勝てる仕組みが完成しました！
