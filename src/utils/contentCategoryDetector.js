/**
 * 写真の被写体からカテゴリーを推定する
 *
 * imageDescription（Claude画像分析結果）のキーワードを検索し、
 * 店舗カテゴリーと異なる被写体カテゴリーを検出する。
 * 例: カフェ店主が家具の写真を使った場合 → '家具店' を返す
 */

/**
 * 被写体キーワード → カテゴリーラベル のマッピング
 * 上から順にマッチング（優先度順）
 */
const CONTENT_KEYWORD_MAP = [
  // ── ネイル ──
  {
    category: 'ネイルサロン',
    keywords: ['ネイル', 'ジェルネイル', 'ネイルアート', 'マニキュア', 'ネイルチップ'],
  },
  // ── ヘア ──
  {
    category: '美容室',
    keywords: ['ヘアカラー', 'ヘアスタイル', 'カラーリング', 'パーマ', 'ハイライト', 'ブリーチ', 'ヘアカット'],
  },
  // ── フラワー ──
  {
    category: '花屋',
    keywords: ['花束', 'ブーケ', 'フラワーアレンジ', 'アレンジメント', 'バラ', 'チューリップ', 'ひまわり', '生花'],
  },
  // ── アクセサリー ──
  {
    category: 'アクセサリーショップ',
    keywords: ['ピアス', 'イヤリング', 'リング', 'ネックレス', 'ブレスレット', 'アクセサリー'],
  },
  // ── スイーツ（カフェより前にチェック） ──
  {
    category: 'スイーツ店',
    keywords: ['ケーキ', 'ショートケーキ', 'チーズケーキ', 'タルト', 'マカロン', 'パフェ', 'プリン', 'チョコレートケーキ', 'シュークリーム'],
  },
  // ── ベーカリー ──
  {
    category: 'ベーカリー',
    keywords: ['食パン', 'クロワッサン', 'バゲット', 'ベーグル', 'マフィン', 'スコーン', 'デニッシュ', 'パン'],
  },
  // ── コーヒー豆専門店（カフェより前にチェック） ──
  {
    category: 'コーヒー豆専門店',
    keywords: ['コーヒー豆', '珈琲豆', '焙煎', '自家焙煎', 'シングルオリジン', 'スペシャルティ', '生豆', 'ロースト', '産地'],
  },
  // ── カフェ系ドリンク ──
  {
    category: 'カフェ',
    keywords: ['コーヒー', 'ラテ', 'カプチーノ', 'エスプレッソ', 'カフェラテ', '珈琲', '抹茶ラテ', 'アイスコーヒー', 'ドリップコーヒー'],
  },
  // ── 和食 ──
  {
    category: '和食店',
    keywords: ['刺身', '寿司', '天ぷら', '蕎麦', 'うどん', '和食', 'お膳', '懐石'],
  },
  // ── 洋食・ファストフード ──
  {
    category: 'レストラン',
    keywords: ['パスタ', 'ピザ', 'ハンバーガー', 'ステーキ', 'ランチプレート', 'ディナー', '料理', '定食'],
  },
  // ── 家具・インテリア ──
  {
    category: '家具店',
    keywords: ['ソファ', '椅子', 'チェア', '本棚', 'シェルフ', 'デスク', '家具', 'ダイニングテーブル', 'テーブル'],
  },
  // ── 雑貨 ──
  {
    category: '雑貨店',
    keywords: ['雑貨', 'キャンドル', '陶器', '置物', 'インテリア小物', 'クッション', 'ポスター'],
  },
  // ── アパレル ──
  {
    category: 'アパレル',
    keywords: ['ニット', 'セーター', 'Tシャツ', 'ドレス', 'スカート', 'パンツ', 'ジャケット', 'コート', '洋服', '服'],
  },
  // ── ハンドメイド ──
  {
    category: 'ハンドメイド作家',
    keywords: ['ハンドメイド', '手作り', '手縫い', '編み物', 'レジン'],
  },
  // ── アート ──
  {
    category: 'アーティスト',
    keywords: ['絵画', 'イラスト', 'アート', 'キャンバス', 'スケッチ'],
  },
  // ── 植物（単独の観葉植物メイン写真） ──
  {
    category: '雑貨店',
    keywords: ['観葉植物', '多肉植物', 'サボテン', '鉢植え'],
  },
];

/**
 * imageDescription テキストから被写体カテゴリーを推定する
 *
 * @param {string} imageDescription - Claude が生成した画像説明テキスト
 * @returns {string|null} - 検出されたカテゴリーラベル、判定不能なら null
 */
export function detectContentCategory(imageDescription) {
  if (!imageDescription) return null;

  // 全キーワードマップをスキャン（上の方が優先度高い）
  // マッチ数が最も多いカテゴリーを採用
  let bestCategory = null;
  let bestCount = 0;

  for (const { category, keywords } of CONTENT_KEYWORD_MAP) {
    const count = keywords.filter(kw => imageDescription.includes(kw)).length;
    if (count > bestCount) {
      bestCount = count;
      bestCategory = category;
    }
  }

  // 1つ以上キーワードがマッチした場合のみ返す
  return bestCount > 0 ? bestCategory : null;
}
